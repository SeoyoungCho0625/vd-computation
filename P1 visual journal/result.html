<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Image Result</title>
    <style>
        /* CSS는 이전과 동일합니다 */
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; background-color: #f9f9f9; padding: 20px; box-sizing: border-box; }
        #result-area { display: flex; flex-direction: column; align-items: center; background: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); }
        canvas { border: 2px dashed #ccc; border-radius: 8px; background-color: #fff; }
        #download-link { display: none; margin-top: 20px; padding: 10px 20px; background-color: #28a745; color: white; text-decoration: none; border-radius: 5px; font-weight: bold; transition: background-color 0.2s; }
        #download-link:hover { background-color: #218838; }
        #loading-text { display: block; margin-top: 20px; font-style: italic; color: #555; }
    </style>
</head>
<body>

    <div id="result-area">
        <h3>Your Result Image</h3>
        <canvas id="image-canvas" width="300" height="300"></canvas>
        <span id="loading-text">Generating...</span>
        <a id="download-link" download="my-daily-avatar.png">Save as PNG</a>
    </div>

    <script>
        // ------------------------------------------------------------------
        // [수정됨] 이미지 소스 구조 변경
        // ------------------------------------------------------------------
        // 'meals'가 0~3이 아닌 breakfast/lunch/dinner와 그 안의 size로 변경됩니다.
        // *임시로* small=회색, medium=노란색, large=초록색을 재사용했습니다.
        // 실제로는 여기에 아침-small.png, 아침-medium.png 등을 연결해야 합니다.
        // ------------------------------------------------------------------
        const IMAGE_SOURCES = {
            meals: {
                breakfast: {
                    'small': 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAYAAAB5fY51AAAAAXNSR0IArs4c6QAAAERlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAA6ABAAMAAAABAAEAAKACAAQAAAABAAAAXKADAAQAAAABAAAAWAAAAABwEa/GAAAAEElEQVR42u3BAQ0AAADCoPdPbQ8HFAAAAAAAAAAAAAAAAAD8upY9AAEAyvRqhQAAAABJRU5ErkJggg==', // 예: Small Breakfast (회색)
                    'medium': 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAYAAAB5fY51AAAAAXNSR0IArs4c6QAAAERlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAA6ABAAMAAAABAAEAAKACAAQAAAABAAAAXKADAAQAAAABAAAAWAAAAABwEa/GAAAAEElEQVR42u3BAQ0AAADCoPdPbQ8HFAAAAAAAAAAAAAAAAAD8upYfAAEAzP9qhQAAAABJRU5ErkJggg==', // 예: Medium Breakfast (노란색)
                    'large': 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAYAAAB5fY51AAAAAXNSR0IArs4c6QAAAERlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAA6ABAAMAAAABAAEAAKACAAQAAAABAAAAXKADAAQAAAABAAAAWAAAAABwEa/GAAAAEElEQVR42u3BAQ0AAADCoPdPbQ8HFAAAAAAAAAAAAAAAAAAAAAAAAAD4dAkAAAEAYoV6AAAAAElFTkSuQmCC'  // 예: Large Breakfast (초록색)
                },
                lunch: {
                    'small': 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAYAAAB5fY51AAAAAXNSR0IArs4c6QAAAERlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAA6ABAAMAAAABAAEAAKACAAQAAAABAAAAXKADAAQAAAABAAAAWAAAAABwEa/GAAAAEElEQVR42u3BAQ0AAADCoPdPbQ8HFAAAAAAAAAAAAAAAAAD8upY9AAEAyvRqhQAAAABJRU5ErkJggg==',
                    'medium': 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAYAAAB5fY51AAAAAXNSR0IArs4c6QAAAERlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAA6ABAAMAAAABAAEAAKACAAQAAAABAAAAXKADAAQAAAABAAAAWAAAAABwEa/GGAAAAEElEQVR42u3BAQ0AAADCoPdPbQ8HFAAAAAAAAAAAAAAAAAD8upYxAAEAyP5qhQAAAABJRU5ErkJggg==', // 점심-중간 (주황색)
                    'large': 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAYAAAB5fY51AAAAAXNSR0IArs4c6QAAAERlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAA6ABAAMAAAABAAEAAKACAAQAAAABAAAAXKADAAQAAAABAAAAWAAAAABwEa/GAAAAEElEQVR42u3BAQ0AAADCoPdPbQ8HFAAAAAAAAAAAAAAAAAAAAAAAAAD4dAkAAAEAYoV6AAAAAElFTkSuQmCC'
                },
                dinner: {
                    'small': 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAYAAAB5fY51AAAAAXNSR0IArs4c6QAAAERlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAA6ABAAMAAAABAAEAAKACAAQAAAABAAAAXKADAAQAAAABAAAAWAAAAABwEa/GAAAAEElEQVR42u3BAQ0AAADCoPdPbQ8HFAAAAAAAAAAAAAAAAAD8upY9AAEAyvRqhQAAAABJRU5ErkJggg==',
                    'medium': 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAYAAAB5fY51AAAAAXNSR0IArs4c6QAAAERlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAA6ABAAMAAAABAAEAAKACAAQAAAABAAAAXKADAAQAAAABAAAAWAAAAABwEa/GAAAAEElEQVR42u3BAQ0AAADCoPdPbQ8HFAAAAAAAAAAAAAAAAAD8upYfAAEAzP9qhQAAAABJRU5ErkJggg==',
                    'large': 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAYAAAB5fY51AAAAAXNSR0IArs4c6QAAAERlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAA6ABAAMAAAABAAEAAKACAAQAAAABAAAAXKADAAQAAAABAAAAWAAAAABwEa/GAAAAEElEQVR42u3BAQ0AAADCoPdPbQ8HFAAAAAAAAAAAAAAAAAAAAAAAAAD4dAkAAAEAYoV6AAAAAElFTkSuQmCC'
                }
            },
            todo: { // 이 부분은 변경 없음
                'high': 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAYAAAB5fY51AAAAAXNSR0IArs4c6QAAAERlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAA6ABAAMAAAABAAEAAKACAAQAAAABAAAAXKADAAQAAAABAAAAWAAAAABwEa/GAAABbUlEQVR42u3bwQnCQBRF0XeGQUIkREV0EB3EBVmIERmBERkQBURBVCQhMggyQnfv2B7u7Q3HmW/ePJ+3J6iqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqsvpyA+B9jnefyXkX8IXseQkAgGQAgGwAgGwAgGwAgGQAgGwAgGwAgGQAgGQAgGwAgGQAgGQAgGQAgGQAgGQAgGQAgGQAgGQAgGQAgGQAgGQAgGQAgGQAgGQAgGQAgGQAgGQAgGQAgGQAgGQAgGQAgGQAgGQAgGQAgGQAgGQAgGQAgGQAgGQAgGQAgGwAgGQAgGQAgGQAgGQAgGQAgGQAgGQAgGQAgGQAgGQAgGQAgGQAgGQAgGQAgGQAgGQAgGQAgGQAgGQAgGQAgGQAgGQAgGQAgGQAgGQAgGQAgGQAgGQAgGQAgGQAgGQAgGQAgGQAgGQAgGQAQCyz0e/2G9/AAB/wkEAAGQAgGwAgGwAgGQAgGwAgGQAgGwAgGQAgGQAQCwPy0EAGQAgGwAgGQAQCyzwe/3sd/HePylqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqrf9AOVwJjks0gcAAAAAASUVORK5CYII=', 
                'medium': 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAYAAAB5fY51AAAAAXNSR0IArs4c6QAAAERlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAA6ABAAMAAAABAAEAAKACAAQAAAABAAAAXKADAAQAAAABAAAAWAAAAABwEa/GAAABHElEQVR42u3dsQkAMAhEUe/d/YT9qAQQMvEwQGg2m4dHeJcWAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABgqRMAAEg+AQASPgcAAKSfAQBINgIAkD8LAMAkwDIBAMC0AIAkAwCQZAIAJBsAgGQDAJAkAwCQZAYAkAwCQNIBAGQGAJAkAgCQbAAAkAwCQJAMAECSCQBAkgkAQJIIAEAyAQBINgAAyQYAIJkAAEg2AABIJgAAyQYAIJkAAEg2AQCQBwCA5AMAADwIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD4XweAAEAFMGlbAAAAAElFTkSuQmCC', 
                'low': 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAYAAAB5fY51AAAAAXNSR0IArs4c6QAAAERlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAA6ABAAMAAAABAAEAAKACAAQAAAABAAAAXKADAAQAAAABAAAAWAAAAABwEa/GAAAAEElEQVR42u3BAQ0AAADCoPdPbQ8HFAAAAAAAAAAAAAAAAAD8upYfAAEAzP9qhQAAAABJRU5ErkJggg=='
            },
            exercise: { // 이 부분은 변경 없음
                'yes': 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAYAAAB5fY51AAAAAXNSR0IArs4c6QAAAERlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAA6ABAAMAAAABAAEAAKACAAQAAAABAAAAXKADAAQAAAABAAAAWAAAAABwEa/GAAABfElEQVR42u3dwQnCQBRF0XmGEBmIERnEBVmIERmIERmIERnEBVkREVkREdHxPdnD/bYHvOd58plxHu9NVFVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVWV+XoD4H0u93ku510Av+SXlwAASKYAEimARAIgkQRIIgGQSAIkUgCJBEAiCZBIAiRSAIkEQCIJkEgCJJIAiSRAIgmQSAMkkgBJJACSSAAkkgBJJACSSAAkkgBJJACSSAAkkgBJJACSSAAkkgBJJACSSAAkkgBJJACSSAAkkgBJJACSSAAkkgBJJACSSAAkkgBJJACSSAAkkgBJJACSSAAkkgBJJACSSAAkkgBJJACSSAAkkgBJJACSSAAkkgBJJACSSAAkkgBJJACSSAAkkgBJJACSSAAkkgBJJACSSAAkkgBJJACSSAAkkgBJJACSSAAkkgBJJACSSAAkkQBIIgGSyEC/2+9+AwD4S44AECmARBIgkQRIJAGQSAIkUgCJBEAiCZBIAiRSAIkEQCIJkEgCJJEAiSRAIgmQSAMkkgBJJACSSAAkkgBIJgGSyEDf+nu/j/E+l6qqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqv4BAz8kYl+qrnUAAAAASUVORK5CYII=', 
                'no': 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAYAAAB5fY51AAAAAXNSR0IArs4c6QAAAERlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAA6ABAAMAAAABAAEAAKACAAQAAAABAAAAXKADAAQAAAABAAAAWAAAAABwEa/GAAAAEElEQVR42u3BAQ0AAADCoPdPbQ8HFAAAAAAAAAAAAAAAAAD8upYfAAEAzP9qhQAAAABJRU5ErkJggg=='
            }
        };

        const canvas = document.getElementById('image-canvas');
        const ctx = canvas.getContext('2d');
        const downloadLink = document.getElementById('download-link');
        const loadingText = document.getElementById('loading-text');

        // 이미지 로드 함수 (변경 없음)
        function loadImages(sources) {
            const promises = sources.map(src => {
                if (!src) return Promise.resolve(new Image()); 
                return new Promise((resolve, reject) => {
                    const img = new Image();
                    img.onload = () => resolve(img);
                    img.onerror = reject;
                    img.src = src;
                });
            });
            return Promise.all(promises);
        }

        // 페이지 로드 시 실행
        window.addEventListener('DOMContentLoaded', async () => {
            
            // 1. URL에서 설문 값 가져오기 (오늘 무엇을 먹었는지)
            const urlParams = new URLSearchParams(window.location.search);
            const todoValue = urlParams.get('todo') || 'high';
            const exerciseValue = urlParams.get('exercise') || 'yes';

            // 2. [신규] localStorage에서 설정 값 가져오기 (평소 비중)
            // 저장된 값이 없으면 'medium'을 기본값으로 사용
            const breakfastSize = localStorage.getItem('mealSize_breakfast') || 'medium';
            const lunchSize = localStorage.getItem('mealSize_lunch') || 'medium';
            const dinnerSize = localStorage.getItem('mealSize_dinner') || 'medium';

            // 3. [수정됨] 불러올 이미지 목록(sourcesToLoad) 생성
            const sourcesToLoad = [];

            // 3-1. 배경 레이어 먼저 추가 (할 일, 운동)
            sourcesToLoad.push(IMAGE_SOURCES.todo[todoValue]);
            sourcesToLoad.push(IMAGE_SOURCES.exercise[exerciseValue]);

            // 3-2. [수정됨] 식사 레이어 추가 (선택된 것만, 설정된 크기로)
            // 그리는 순서: 아침(맨아래) -> 점심 -> 저녁(맨위) (첨부한 이미지 참고)
            if (urlParams.has('breakfast')) {
                sourcesToLoad.push(IMAGE_SOURCES.meals.breakfast[breakfastSize]);
            }
            if (urlParams.has('lunch')) {
                sourcesToLoad.push(IMAGE_SOURCES.meals.lunch[lunchSize]);
            }
            if (urlParams.has('dinner')) {
                sourcesToLoad.push(IMAGE_SOURCES.meals.dinner[dinnerSize]);
            }

            try {
                // 4. [수정됨] 모든 선택된 이미지를 불러옴
                const loadedImages = await loadImages(sourcesToLoad);
                
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                // 5. [수정됨] 불러온 이미지들을 순서대로 캔버스에 모두 그림
                for (const img of loadedImages) {
                    if (img.width > 0) { // 빈 이미지가 아닐 경우에만 그립니다.
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    }
                }

                // 6. 다운로드 링크 생성 (기존과 동일)
                const dataURL = canvas.toDataURL('image/png');
                downloadLink.href = dataURL;
                downloadLink.style.display = 'block';
                loadingText.style.display = 'none';

            } catch (error) {
                console.error('Failed to load or draw images:', error);
                loadingText.textContent = 'Error generating image.';
                loadingText.style.color = 'red';
            }
        });

    </script>
</body>
</html>