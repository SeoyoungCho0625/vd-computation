<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Image Result</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; background-color: #fefee5; padding: 20px; box-sizing: border-box; }
        #result-area { display: flex; flex-direction: column; align-items: center; background: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); }
        canvas { 
            width: 400px; 
            height: 400px; 
            border: 2px dashed #ccc; 
            border-radius: 8px; 
            background-color: #fff; 
        }
        #download-link { display: none; margin-top: 20px; padding: 10px 20px; background-color: #28a745; color: white; text-decoration: none; border-radius: 5px; font-weight: bold; transition: background-color 0.2s; }
        #download-link:hover { background-color: #218838; }
        #loading-text { display: block; margin-top: 20px; font-style: italic; color: #555; }
        
        /* [style íƒœê·¸ ì•ˆì— ì¶”ê°€] ê°ì • ë²„íŠ¼ ê³µí†µ ìŠ¤íƒ€ì¼ */
        .emotion-btn {
            transition: all 0.2s ease; /* 0.2ì´ˆ ë™ì•ˆ ë¶€ë“œëŸ½ê²Œ ë³€í•¨ */
        }

        .emotion-btn:hover {
            transform: translateY(-2px) scale(1.05); /* ìœ„ë¡œ ì‚´ì§ ëœ¨ë©´ì„œ ì»¤ì§ */
            filter: brightness(0.9);    /* ìƒ‰ê¹”ì´ ì‚´ì§ ì§„í•´ì§ (ì–´ë‘ì›Œì§) */
            box-shadow: 0 6px 12px rgba(0,0,0,0.2) !important; /* ê·¸ë¦¼ìê°€ ë” ì„ ëª…í•´ì§ */
        }

        /* í´ë¦­í–ˆì„ ë•Œ ì‚´ì§ ëˆŒë¦¬ëŠ” íš¨ê³¼ (ì„ íƒ ì‚¬í•­) */
        .emotion-btn:active {
            transform: translateY(0) scale(0.95);
            filter: brightness(0.8);
        }
    /* [CSS íŒŒì¼ ë˜ëŠ” <style> íƒœê·¸ ì•ˆì— ì¶”ê°€] */

    #loading-overlay {
        display: none; /* í‰ì†Œì—ëŠ” ìˆ¨ê¹€ */
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(255, 255, 255, 0.95); /* ë°°ê²½ì„ ì‚´ì§ ë¶ˆíˆ¬ëª…í•˜ê²Œ */
        z-index: 9999; /* ëª¨ë“  ìš”ì†Œë³´ë‹¤ ìœ„ì— ëœ¨ë„ë¡ */
        justify-content: center;
        align-items: center;
        flex-direction: column;
    }

    .loader-content {
        text-align: center;
        animation: fadeIn 0.5s ease-out;
    }

    .loader-content p {
        margin-top: 20px;
        font-size: 1.2em;
        color: #333;
        font-weight: bold;
        font-family: sans-serif;
    }

    /* ë¹™ê¸€ë¹™ê¸€ ë„ëŠ” ì› ì• ë‹ˆë©”ì´ì…˜ */
    .spinner {
        width: 50px;
        height: 50px;
        border: 5px solid #f3f3f3;
        border-top: 5px solid #007aff; /* íŒŒë€ìƒ‰ í¬ì¸íŠ¸ */
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto; /* ì¤‘ì•™ ì •ë ¬ */
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    </style>
</head>
<body>

    <div id="result-area">
        <h3>Here's your day in an image</h3>
        <canvas id="image-canvas" width="600" height="600"></canvas>
        <span id="loading-text">Generating...</span>
        <a id="download-link" download="my-daily-avatar.png">Save your Today!</a>
        <div style="margin-top: 30px; text-align: center; border-top: 1px dashed #ccc; padding-top: 20px; width: 100%;">
            
    <p style="margin-bottom: 15px; font-weight: 500; color: #555;">How did you feel today?</p>
    
   <div style="display: flex; flex-direction: column; gap: 15px; align-items: center;">
    
    <div style="display: flex; gap: 15px; justify-content: center;">
        <button onclick="viewAnimation('calm')" class="emotion-btn" style="padding: 12px 20px; background: #87CEEB; border: none; border-radius: 25px; cursor: pointer; color: white; font-weight: bold; font-size: 0.9em; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
            â˜ï¸ Calm
        </button>
        <button onclick="viewAnimation('active')" class="emotion-btn" style="padding: 12px 20px; background: #FF7F50; border: none; border-radius: 25px; cursor: pointer; color: white; font-weight: bold; font-size: 0.9em; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
            â˜€ï¸ Happy
        </button>
        <button onclick="viewAnimation('angry')" class="emotion-btn" style="padding: 12px 20px; background: #f85d24; border: none; border-radius: 25px; cursor: pointer; color: white; font-weight: bold; font-size: 0.9em; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
            ğŸ”¥ Angry
        </button>
    </div>
    
    <div style="display: flex; gap: 15px; justify-content: center;">
        <button onclick="viewAnimation('chaos')" class="emotion-btn" style="padding: 12px 20px; background: #9f7ce5; border: none; border-radius: 25px; cursor: pointer; color: white; font-weight: bold; font-size: 0.9em; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
            ğŸŒ€ Chaos
        </button>
        <button onclick="viewAnimation('love')" class="emotion-btn" style="padding: 12px 20px; background: #f57bb8; border: none; border-radius: 25px; cursor: pointer; color: white; font-weight: bold; font-size: 0.9em; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
            ğŸ’• Excited
        </button>
        <button onclick="viewAnimation('anxious')" class="emotion-btn" style="padding: 12px 20px; background: #45d0c9; border: none; border-radius: 25px; cursor: pointer; color: white; font-weight: bold; font-size: 0.9em; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
            ğŸ˜¨ Anxious
        </button>
    </div>

</div>

</div>

<script>
    // [result.htmlì˜ <script> ì•ˆì— ìˆëŠ” viewAnimation í•¨ìˆ˜ë¥¼ ì´ê±¸ë¡œ êµì²´]

function viewAnimation(mode) {
    // 1. ë¡œë”© í™”ë©´ì„ ë³´ì—¬ì¤ë‹ˆë‹¤ (Flexboxë¡œ ì„¤ì •í•˜ì—¬ ì¤‘ì•™ ì •ë ¬)
    document.getElementById('loading-overlay').style.display = 'flex';

    // 2. 3ì´ˆ(3000ms) ë’¤ì— í˜ì´ì§€ë¥¼ ì´ë™í•©ë‹ˆë‹¤
    setTimeout(() => {
        const currentParams = new URLSearchParams(window.location.search);
        currentParams.set('mode', mode);
        window.location.href = 'animation.html?' + currentParams.toString();
    }, 3000); // <-- ì—¬ê¸°ì„œ ì‹œê°„ ì¡°ì ˆ ê°€ëŠ¥ (1000 = 1ì´ˆ)
}
</script>
    </div>
    
    <script>
        // ì‚¬ìš©ìê°€ ì œê³µí•œ IMAGE_SOURCESë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤
        const IMAGE_SOURCES = {
            meals: {
                'small':  { src: 'meal1.png', x: 340, y: 340 }, 
                'medium': { src: 'meal2.png', x: 340, y: 340 }, 
                'large':  { src: 'meal3.png', x: 340, y: 340 }  
            },
            todo: { 
                'high':   { src: 'todo2.png', x: 250, y: 250 },
                'medium': { src: 'todo1.png', x: 250, y: 250 },
                'low':    { src: 'todo3.png', x: 250, y: 250 }
            },
            exercise: { 
                'workout': { src: 'workout1.png', x: 300, y: 300 }, 
                'water':   { src: 'water1.png', x: 300, y: 300 }
            },
            relationship: {
                'low':    { src: 'relationship1.png', x: 300, y: 300 },
                'medium': { src: 'relationship2.png', x: 300, y: 300 },
                'high':   { src: 'relationship3.png', x: 300, y: 300 }
            }
        };

        const canvas = document.getElementById('image-canvas');
        const ctx = canvas.getContext('2d');
        const downloadLink = document.getElementById('download-link');
        const loadingText = document.getElementById('loading-text');

        // ------------------------------------------------------------------
        // [ìˆ˜ì •ì‚¬í•­ 1] localStorage ê°’ì„ ì•ˆì „í•˜ê²Œ í™•ì¸í•˜ëŠ” í—¬í¼ í•¨ìˆ˜ ì¶”ê°€
        // ------------------------------------------------------------------
        function getMealAssignment(mealType) {
            const key = `mealAssignment_${mealType}`;
            let value = localStorage.getItem(key);
            
            // ì €ì¥ëœ ê°’ì´ 'small', 'medium', 'large' ì¤‘ í•˜ë‚˜ê°€ ì•„ë‹ˆë©´
            // (ì¦‰, ë¹„ì–´ìˆê±°ë‚˜ 'image1' ê°™ì€ ì˜ˆì „ ê°’ì´ë©´) 'medium'ì„ ê¸°ë³¸ê°’ìœ¼ë¡œ ì‚¬ìš©
            if (value !== 'small' && value !== 'medium' && value !== 'large') {
                value = 'medium';
            }
            return value;
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
        window.addEventListener('DOMContentLoaded', async () => {
            
            // 1. URL ê°’ ê°€ì ¸ì˜¤ê¸° (ì‚¬ìš©ì ì½”ë“œì™€ ë™ì¼)
            const urlParams = new URLSearchParams(window.location.search);
            const todoValue = urlParams.get('todo') || 'high';
            const exerciseValues = urlParams.getAll('exercise');
            const relationshipValue = parseInt(urlParams.get('relationship') || '50', 10);

            // ------------------------------------------------------------------
            // [ìˆ˜ì •ì‚¬í•­ 2] í—¬í¼ í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ë„ë¡ 3ì¤„ ë³€ê²½
            // ------------------------------------------------------------------
            const breakfastAssign = getMealAssignment('breakfast');
            const lunchAssign = getMealAssignment('lunch');
            const dinnerAssign = getMealAssignment('dinner');

            // 3. relationship ê°’ ë³€í™˜ (ì‚¬ìš©ì ì½”ë“œì™€ ë™ì¼)
            let relationshipKey;
            if (relationshipValue <= 33) {
                relationshipKey = 'low';
            } else if (relationshipValue <= 66) {
                relationshipKey = 'medium';
            } else {
                relationshipKey = 'high';
            }

            // 4. ë¶ˆëŸ¬ì˜¬ ì´ë¯¸ì§€ ëª©ë¡ ìƒì„± (ì‚¬ìš©ì ì½”ë“œì™€ ë™ì¼)
            const sourcesToLoad = [];

            sourcesToLoad.push({ ...IMAGE_SOURCES.todo[todoValue], blendMode: 'multiply' });

            if (exerciseValues.includes('workout')) {
                sourcesToLoad.push({ ...IMAGE_SOURCES.exercise.workout, blendMode: 'multiply' });
            }
            if (exerciseValues.includes('water')) {
                sourcesToLoad.push({ ...IMAGE_SOURCES.exercise.water, blendMode: 'multiply' });
            }
            
            sourcesToLoad.push({ ...IMAGE_SOURCES.relationship[relationshipKey], blendMode: 'multiply' });

            // [ì¤‘ìš”] ì´ ë¶€ë¶„ì€ ì´ì œ 'small', 'medium', 'large' í‚¤ë¡œ ì´ë¯¸ì§€ë¥¼ ì˜ ì°¾ìŠµë‹ˆë‹¤.
            if (urlParams.has('breakfast')) {
                sourcesToLoad.push({ ...IMAGE_SOURCES.meals[breakfastAssign], blendMode: 'multiply' });
            }
            if (urlParams.has('lunch')) {
                sourcesToLoad.push({ ...IMAGE_SOURCES.meals[lunchAssign], blendMode: 'multiply' });
            }
            if (urlParams.has('dinner')) {
                sourcesToLoad.push({ ...IMAGE_SOURCES.meals[dinnerAssign], blendMode: 'multiply' });
            }

            try {
                // 5. ì´ë¯¸ì§€ ë¡œë“œ (ì‚¬ìš©ì ì½”ë“œì™€ ë™ì¼)
                const loadedImagePromises = sourcesToLoad.map(item => {
                    return new Promise((resolve, reject) => {
                        if (!item.src) { 
                            resolve({ img: new Image(), ...item });
                            return;
                        }
                        const img = new Image();
                        img.onload = () => resolve({ img: img, ...item });
                        img.onerror = reject;
                        img.src = item.src;
                    });
                });
                const loadedImageObjects = await Promise.all(loadedImagePromises);
                
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                // 6. 300px ê³ ì • í¬ê¸° (ì‚¬ìš©ì ì½”ë“œì™€ ë™ì¼)
                const fixedSize = 300; 

                // 7. ì´ë¯¸ì§€ ê·¸ë¦¬ê¸° (ì‚¬ìš©ì ì½”ë“œì™€ ë™ì¼)
                for (const item of loadedImageObjects) {
                    if (item.img.width > 0) { 
                        ctx.globalCompositeOperation = item.blendMode;
                        
                        const x = item.x - (fixedSize / 2);
                        const y = item.y - (fixedSize / 2);
                        
                        ctx.drawImage(item.img, x, y, fixedSize, fixedSize);
                    }
                }
                
                ctx.globalCompositeOperation = 'source-over'; 

                // 8. ë‹¤ìš´ë¡œë“œ ë§í¬ ìƒì„± (ì‚¬ìš©ì ì½”ë“œì™€ ë™ì¼)
                const dataURL = canvas.toDataURL('image/png');
                downloadLink.href = dataURL;
                downloadLink.style.display = 'block';
                loadingText.style.display = 'none';

            } catch (error) {
                console.error('Failed to load or draw images:', error);
                loadingText.textContent = 'Error generating image.';
                loadingText.style.color = 'red';
            }
        });
    </script>

    <div id="loading-overlay">
    <div class="loader-content">
        <div class="spinner"></div>
        <p>AI is giving the image movement!</p>
    </div>
</div>
</body>
</html>