<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Image Result</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; background-color: #f9f9f9; padding: 20px; box-sizing: border-box; }
        #result-area { display: flex; flex-direction: column; align-items: center; background: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); }
        canvas { 
            width: 600px; 
            height: 600px; 
            border: 2px dashed #ccc; 
            border-radius: 8px; 
            background-color: #fff; 
        }
        #download-link { display: none; margin-top: 20px; padding: 10px 20px; background-color: #28a745; color: white; text-decoration: none; border-radius: 5px; font-weight: bold; transition: background-color 0.2s; }
        #download-link:hover { background-color: #218838; }
        #loading-text { display: block; margin-top: 20px; font-style: italic; color: #555; }
    </style>
</head>
<body>

    <div id="result-area">
        <h3>Your Result Image</h3>
        <canvas id="image-canvas" width="600" height="600"></canvas>
        <span id="loading-text">Generating...</span>
        <a id="download-link" download="my-daily-avatar.png">Save as PNG</a>
    </div>
    
    <script>
        // [수정됨] meals의 키가 'small', 'medium', 'large'로 변경되었습니다.
        // 각 키에 연결된 이미지(meal1.png 등)와 좌표(x, y)를 확인하세요.
        const IMAGE_SOURCES = {
            meals: {
                'small':  { src: 'meal1.png', x: 150, y: 350 }, // '적게' 먹을 때 meal1.png
                'medium': { src: 'meal2.png', x: 300, y: 300 }, // '적당히' 먹을 때 meal2.png
                'large':  { src: 'meal3.png', x: 450, y: 400 }  // '많이' 먹을 때 meal3.png
            },
            todo: { 
                'high':   { src: 'todo2.png', x: 300, y: 300 },
                'medium': { src: 'todo1.png', x: 300, y: 300 },
                'low':    { src: 'todo3.png', x: 300, y: 300 }
            },
            exercise: { 
                'workout': { src: 'workout1.png', x: 450, y: 150 }, 
                'water':   { src: 'water1.png', x: 150, y: 150 }
            },
            relationship: {
                'low':    { src: 'relationship1.png', x: 300, y: 450 },
                'medium': { src: 'relationship2.png', x: 300, y: 450 },
                'high':   { src: 'relationship3.png', x: 300, y: 450 }
            }
        };

        const canvas = document.getElementById('image-canvas');
        const ctx = canvas.getContext('2d');
        const downloadLink = document.getElementById('download-link');
        const loadingText = document.getElementById('loading-text');

        // 페이지 로드 시 실행
        window.addEventListener('DOMContentLoaded', async () => {
            
            // 1. URL 값 가져오기 (변경 없음)
            const urlParams = new URLSearchParams(window.location.search);
            const todoValue = urlParams.get('todo') || 'high';
            const exerciseValues = urlParams.getAll('exercise');
            const relationshipValue = parseInt(urlParams.get('relationship') || '50', 10);

            // 2. [수정됨] setup.html과 동일한 localStorage 키를 사용합니다.
            // 기본값으로 'medium'을 사용합니다.
            const breakfastAssign = localStorage.getItem('mealAssignment_breakfast') || 'medium';
            const lunchAssign = localStorage.getItem('mealAssignment_lunch') || 'medium';
            const dinnerAssign = localStorage.getItem('mealAssignment_dinner') || 'medium';

            // 3. relationship 값 변환 (변경 없음)
            let relationshipKey;
            if (relationshipValue <= 33) {
                relationshipKey = 'low';
            } else if (relationshipValue <= 66) {
                relationshipKey = 'medium';
            } else {
                relationshipKey = 'high';
            }

            // 4. 불러올 이미지 목록 생성 (로직 변경 없음)
            const sourcesToLoad = [];

            // [수정됨] IMAGE_SOURCES에서 객체를 가져올 때 스프레드 연산자(...)를 사용합니다.
            // (src, x, y 값을 모두 복사해옴)
            sourcesToLoad.push({ ...IMAGE_SOURCES.todo[todoValue], blendMode: 'multiply' });

            if (exerciseValues.includes('workout')) {
                sourcesToLoad.push({ ...IMAGE_SOURCES.exercise.workout, blendMode: 'multiply' });
            }
            if (exerciseValues.includes('water')) {
                sourcesToLoad.push({ ...IMAGE_SOURCES.exercise.water, blendMode: 'multiply' });
            }
            
            sourcesToLoad.push({ ...IMAGE_SOURCES.relationship[relationshipKey], blendMode: 'multiply' });

            // [수정됨] breakfastAssign 키는 이제 'small', 'medium', 'large'입니다.
            if (urlParams.has('breakfast')) {
                sourcesToLoad.push({ ...IMAGE_SOURCES.meals[breakfastAssign], blendMode: 'multiply' });
            }
            if (urlParams.has('lunch')) {
                sourcesToLoad.push({ ...IMAGE_SOURCES.meals[lunchAssign], blendMode: 'multiply' });
            }
            if (urlParams.has('dinner')) {
                sourcesToLoad.push({ ...IMAGE_SOURCES.meals[dinnerAssign], blendMode: 'multiply' });
            }

            try {
                // 5. 이미지 로드
                const loadedImagePromises = sourcesToLoad.map(item => {
                    return new Promise((resolve, reject) => {
                        if (!item.src) { 
                            resolve({ img: new Image(), ...item });
                            return;
                        }
                        const img = new Image();
                        img.onload = () => resolve({ img: img, ...item });
                        img.onerror = reject;
                        img.src = item.src;
                    });
                });
                const loadedImageObjects = await Promise.all(loadedImagePromises);
                
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                // ----------------------------------------------------
                // [수정됨] 모든 이미지 크기를 300x300으로 고정합니다.
                // ----------------------------------------------------
                const fixedSize = 300; 

                // 6. 이미지 그리기
                for (const item of loadedImageObjects) {
                    if (item.img.width > 0) { 
                        ctx.globalCompositeOperation = item.blendMode;
                        
                        const x = item.x - (fixedSize / 2);
                        const y = item.y - (fixedSize / 2);
                        
                        ctx.drawImage(item.img, x, y, fixedSize, fixedSize);
                    }
                }
                
                ctx.globalCompositeOperation = 'source-over'; 

                // 7. 다운로드 링크 생성
                const dataURL = canvas.toDataURL('image/png');
                downloadLink.href = dataURL;
                downloadLink.style.display = 'block';
                loadingText.style.display = 'none';

            } catch (error) {
                console.error('Failed to load or draw images:', error);
                loadingText.textContent = 'Error generating image.';
                loadingText.style.color = 'red';
            }
        });
    </script>
</body>
</html>